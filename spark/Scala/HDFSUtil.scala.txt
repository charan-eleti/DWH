package com.yeti.edw

import org.apache.hadoop.conf.Configuration
import org.apache.hadoop.fs.{FileSystem, Path}

object HDFSUtil {
  private val conf = new Configuration()
  private val hdfsCoreSitePath = new Path("/etc/hadoop/conf/core-ste.xml")
  private val hdfsHDFSSitePath = new Path("/etc/hadoop/conf/hdfs-site.xml")
  conf.addResource(hdfsCoreSitePath)
  conf.addResource(hdfsHDFSSitePath)
  var fileSystem: FileSystem = null
  init()

  //val fs = FileSystem.get(new URI("hdfs://sandbox.hortonworks.com/"), conf)

  def init(fs: FileSystem = null) = {
    if(null == fs){
      fileSystem = FileSystem.get(conf)
    } else{
      fileSystem = fs
    }
  }

  def exists(path: String): Boolean = {
    val p = new Path(path)
    fileSystem.exists(p)
  }

  def recreateDirectory(path: String): Unit ={
    deleteDirectory(path)
    createDirectory(path)
  }

  def deleteDirectory(path: String): Unit ={
    val dirPath = new Path(path)
    fileSystem.delete(dirPath, true)
  }

  def createDirectory(dirPath: String): Unit ={
    val path = new Path(dirPath)
    if(!fileSystem.exists(path)){
      fileSystem.mkdirs(path)
    }
  }

  def listDirectories(path: String, fullPath: Boolean): List[String] = {
    var list: List[String] = List[String]()
    val status = fileSystem.listStatus(new Path(path))
    if(fullPath){
      status.foreach(x => list ::= x.getPath.toString)
    } else {
      status.foreach(x => list ::= x.getPath.getName)
    }
    list
  }

  def moveFileOrDir(src: String, target: String): Unit = {
    val srcPath = new Path(src)
    val targetPath = new Path(target)
    if(fileSystem.exists(srcPath)){
      fileSystem.rename(srcPath, targetPath)
    }
  }

  def moveNestedDir(srcDir: String, targetDir: String): Unit = {
    val srcFiles = listDirectories(srcDir, false)
    for(srcFile <- srcFiles){
      if(exists(srcDir + "/" + srcFile)) {
        val targetFiles = listDirectories(srcDir + "/" + srcFile, false)
        for (targetFile <- targetFiles) {
          if (exists(targetDir + "/" + srcFile + "/" + targetFile)) {
            deleteDirectory(targetDir + "/" + srcFile + "/" + targetFile)
          }
          moveFileOrDir(srcDir + "/" + srcFile + "/" + targetFile, targetDir + "/" + srcFile)
        }
      }
    }
  }

}
