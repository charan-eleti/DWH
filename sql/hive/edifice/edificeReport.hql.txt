##staging for the first time

DROP TABLE IF EXISTS DEFAULT.EDIFICE_STG;
CREATE EXTERNAL TABLE IF NOT EXISTS DEFAULT.EDIFICE_STG
(
	Retailer STRING,
	account	STRING,
	custnum STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	weekending	DATE
)
STORED AS TEXTFILE
LOCATION "adl://yetiadls.azuredatalakestore.net/clusters/data/raw/edifice/fullload";


DROP TABLE IF EXISTS EDW.EDIFICE;
CREATE EXTERNAL TABLE IF NOT EXISTS EDW.EDIFICE
(
	ID STRING,
	account	STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	lastUPD	TIMESTAMP
)
PARTITIONED BY (Retailer STRING,year_day DATE)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
STORED AS TEXTFILE
LOCATION 'adl://yetiadls.azuredatalakestore.net/clusters/data/03_transformed/edifice';

INSERT OVERWRITE TABLE EDW.EDIFICE PARTITION(Retailer,year_day) 
SELECT CONCAT(cast(UPC as STRING), Retailer, CAST(weekending as STRING), CAST(Storenumber as STRING)) as ID,
account,
upc,
storenumber,
qs,
qa,
qr,
qu,
xr,
flag,
from_unixtime(unix_timestamp(CURRENT_TIMESTAMP)) AS lastUPD,
Retailer,
weekending AS year_day
FROM DEFAULT.EDIFICE_STG;

DROP TABLE IF EXISTS EDW.EDIFICE_ORC;
CREATE TABLE IF NOT EXISTS EDW.EDIFICE_ORC
(
	ID STRING,
	account	STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	lastUPD	TIMESTAMP
)
PARTITIONED BY (Retailer STRING,year_day DATE)
STORED AS ORC;

#####

###incremental loads

MSCK REPAIR TABLE edw_tz.edifice_stg;
DROP TABLE IF EXISTS edw.EDIFICE;
CREATE TABLE IF NOT EXISTS edw.EDIFICE AS 
SELECT ID
      ,Account
      , CAST(CASE   
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','aafes','%') THEN '100873'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','academy','%') THEN '101354'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','bass','%') THEN '101213'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','cabelas','%') THEN '100121'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','dicks','%') THEN '101583'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','field','%') THEN '101583'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','gander','%') THEN '100914'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','golf','%') THEN '101583'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','hibbett','%') THEN '102173'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','moosejaw','%') THEN '103430'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','nexcom','%') THEN '106889'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','olympia','%') THEN '106838'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','rei','%') THEN '100434'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','ruralking','%') THEN '101886'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','scheelssports','%') THEN '100710'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','sportsmanswarehouse','%') THEN '100395'
        WHEN ltrim(rtrim(lower(retailer))) like concat('%','westmarine','%') THEN '100463'
            ELSE 'NULL' 
       END AS INT) AS Custnum
      , UPC 
      , STORENUMBER
      , QS
      , QA
      , QR
      , QU
      , XR
      , flag
      , lastUPD
      , Retailer
      , year_day
 FROM edw_tz.edifice_stg;
