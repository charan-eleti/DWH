##staging for the first time

DROP TABLE IF EXISTS DEFAULT.EDIFICE_STG;
CREATE EXTERNAL TABLE IF NOT EXISTS DEFAULT.EDIFICE_STG
(
	Retailer STRING,
	account	STRING,
	custnum STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	weekending	DATE
)
STORED AS TEXTFILE
LOCATION "adl://yetiadls.azuredatalakestore.net/clusters/data/raw/edifice/fullload";


DROP TABLE IF EXISTS EDW.EDIFICE;
CREATE EXTERNAL TABLE IF NOT EXISTS EDW.EDIFICE
(
	ID STRING,
	account	STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	lastUPD	TIMESTAMP
)
PARTITIONED BY (Retailer STRING,year_day DATE)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
STORED AS TEXTFILE
LOCATION 'adl://yetiadls.azuredatalakestore.net/clusters/data/raw/edifice/target';

INSERT OVERWRITE TABLE EDW.EDIFICE PARTITION(Retailer,year_day) 
SELECT CONCAT(cast(UPC as STRING), Retailer, CAST(weekending as STRING), CAST(Storenumber as STRING)) as ID,
account,
upc,
storenumber,
qs,
qa,
qr,
qu,
xr,
flag,
from_unixtime(unix_timestamp(CURRENT_TIMESTAMP)) AS lastUPD,
Retailer,
weekending AS year_day
FROM DEFAULT.EDIFICE_STG;

DROP TABLE IF EXISTS EDW.EDIFICE_ORC;
CREATE TABLE IF NOT EXISTS EDW.EDIFICE_ORC
(
	ID STRING,
	account	STRING,
	upc	STRING,
	storenumber	STRING,
	qs	INT,
	qa	INT,
	qr	INT,
	qu	INT,
	xr	DOUBLE,
	flag	CHAR(1),
	lastUPD	TIMESTAMP
)
PARTITIONED BY (Retailer STRING,year_day DATE)
STORED AS ORC;

#####

###incremental loads

MSCK REPAIR TABLE EDW.EDIFICE;

INSERT OVERWRITE TABLE EDW.EDIFICE_ORC PARTITION(Retailer,year_day) 
SELECT ID,
account,
upc,
storenumber,
qs,
qa,
qr,
qu,
xr,
flag,
lastUPD,
Retailer,
year_day
FROM EDW.EDIFICE;
